<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Goals Predictor Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .match-row:hover {
            background-color: #f0f8ff !important;
            transform: translateY(-1px);
            transition: all 0.2s;
        }
        .probability-high {
            color: #28a745;
            font-weight: bold;
        }
        .probability-medium {
            color: #ffc107;
            font-weight: bold;
        }
        .probability-low {
            color: #dc3545;
        }
        .live-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark-mode .match-container {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark-mode .match-row {
            border-color: #4a5568;
        }
        .dark-mode select, .dark-mode input {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }
        .stat-card {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f0ff 100%);
        }
        .dark-mode .stat-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4 max-w-7xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">⚽ Football Goals Predictor Pro</h1>
            <button id="darkModeToggle" class="px-3 py-1 bg-gray-200 rounded-lg text-sm dark:bg-gray-700">Dark Mode</button>
        </div>
        
        <div class="flex flex-wrap gap-4 mb-6">
            <div class="flex border-b">
                <button id="inplayTab" class="px-4 py-2 font-medium border-b-2 border-blue-500 text-blue-600">
                    In-Play Matches
                </button>
                <button id="upcomingTab" class="px-4 py-2 font-medium text-gray-500">
                    Upcoming Matches
                </button>
                <button id="predictionsTab" class="px-4 py-2 font-medium text-gray-500">
                    Detailed Predictions
                </button>
            </div>
            
            <div class="flex items-center gap-4 ml-auto">
                <div>
                    <label class="mr-2 font-medium">League:</label>
                    <select id="leagueFilter" class="border p-1 rounded bg-white dark:bg-gray-700">
                        <option value="all">All Leagues</option>
                    </select>
                </div>
                <div>
                    <label class="mr-2 font-medium">Goal Probability:</label>
                    <select id="probabilityFilter" class="border p-1 rounded bg-white dark:bg-gray-700">
                        <option value="all">All</option>
                        <option value="70">70%+</option>
                        <option value="50">50%+</option>
                        <option value="30">30%+</option>
                    </select>
                </div>
                <button id="refreshBtn" class="px-3 py-1 bg-blue-500 text-white rounded-lg flex items-center gap-1 hover:bg-blue-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <div id="loading" class="text-center py-8 hidden">
            <div class="loader"></div>
            <p class="mt-2">Loading matches and predictions...</p>
        </div>

        <div id="errorMessage" class="hidden p-4 bg-red-100 text-red-700 rounded mb-4 dark:bg-red-900 dark:text-red-100"></div>

        <!-- Main Matches Container -->
        <div id="matchesContainer" class="bg-white rounded-lg shadow overflow-hidden match-container dark:bg-gray-800">
            <!-- Content will be loaded by JavaScript -->
        </div>

        <!-- Detailed Predictions Container (hidden by default) -->
        <div id="predictionsContainer" class="hidden mt-8">
            <h2 class="text-2xl font-bold mb-4 text-blue-600 dark:text-blue-400">Advanced Match Predictions</h2>
            <div id="predictionsContent" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Predictions will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ======================== CONFIGURATION ========================
        const API_KEY = '2216a37711324078a6ed1cf8f22870e5'; // REPLACE WITH YOUR API KEY
        const TIMEZONE = 'Europe/London';
        const SEASON = new Date().getFullYear(); // Current season
        
        // ======================== APP STATE ========================
        let currentTab = 'inplay';
        let allMatches = [];
        let allPredictions = {};
        let autoRefreshInterval;
        let historicalDataCache = {};

        // ======================== DOM ELEMENTS ========================
        const elements = {
            inplayTab: document.getElementById('inplayTab'),
            upcomingTab: document.getElementById('upcomingTab'),
            predictionsTab: document.getElementById('predictionsTab'),
            loading: document.getElementById('loading'),
            matchesContainer: document.getElementById('matchesContainer'),
            predictionsContainer: document.getElementById('predictionsContainer'),
            predictionsContent: document.getElementById('predictionsContent'),
            errorMessage: document.getElementById('errorMessage'),
            leagueFilter: document.getElementById('leagueFilter'),
            probabilityFilter: document.getElementById('probabilityFilter'),
            refreshBtn: document.getElementById('refreshBtn'),
            darkModeToggle: document.getElementById('darkModeToggle')
        };

        // ======================== EVENT LISTENERS ========================
        elements.inplayTab.addEventListener('click', () => switchTab('inplay'));
        elements.upcomingTab.addEventListener('click', () => switchTab('upcoming'));
        elements.predictionsTab.addEventListener('click', () => switchTab('predictions'));
        elements.leagueFilter.addEventListener('change', filterMatches);
        elements.probabilityFilter.addEventListener('change', filterMatches);
        elements.refreshBtn.addEventListener('click', fetchData);
        elements.darkModeToggle.addEventListener('click', toggleDarkMode);

        // ======================== INITIALIZATION ========================
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            startAutoRefresh();
            
            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                elements.darkModeToggle.textContent = 'Light Mode';
            }
        });

        // ======================== MAIN FUNCTIONS ========================

        async function fetchData() {
            elements.loading.classList.remove('hidden');
            elements.errorMessage.classList.add('hidden');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Fetch fixtures based on current tab
                const fixturesUrl = currentTab === 'inplay' 
                    ? `https://v3.football.api-sports.io/fixtures?live=all&timezone=${TIMEZONE}`
                    : `https://v3.football.api-sports.io/fixtures?date=${today}&timezone=${TIMEZONE}`;
                
                const fixturesResponse = await axios.get(fixturesUrl, {
                    headers: { 'x-apisports-key': API_KEY }
                });
                
                allMatches = fixturesResponse.data.response || [];
                
                // Sort matches by time (soonest first for upcoming, most recently started for in-play)
                allMatches.sort((a, b) => {
                    return currentTab === 'inplay' 
                        ? new Date(b.fixture.date) - new Date(a.fixture.date)
                        : new Date(a.fixture.date) - new Date(b.fixture.date);
                });
                
                // For upcoming matches, fetch detailed predictions
                if (currentTab !== 'inplay') {
                    await fetchDetailedPredictions();
                }
                
                updateLeagueFilter();
                filterMatches();
                
                // If on predictions tab, show them
                if (currentTab === 'predictions') {
                    showDetailedPredictions();
                }
            } catch (error) {
                showError('Error loading data. Please try again later.');
                console.error('Error:', error);
            } finally {
                elements.loading.classList.add('hidden');
            }
        }

        async function fetchDetailedPredictions() {
            // Clear previous predictions
            allPredictions = {};
            
            // For each match, get detailed stats and calculate probabilities
            for (const match of allMatches) {
                if (match.fixture.status.short !== 'NS') continue; // Only upcoming matches
                
                try {
                    const homeTeamId = match.teams.home.id;
                    const awayTeamId = match.teams.away.id;
                    const leagueId = match.league.id;
                    
                    // Get team statistics (with caching)
                    const [homeStats, awayStats, h2hStats] = await Promise.all([
                        getTeamStatistics(leagueId, homeTeamId),
                        getTeamStatistics(leagueId, awayTeamId),
                        getHeadToHead(homeTeamId, awayTeamId)
                    ]);
                    
                    // Calculate probabilities based on multiple factors
                    const prediction = calculateMatchProbabilities(match, homeStats, awayStats, h2hStats);
                    allPredictions[match.fixture.id] = prediction;
                    
                } catch (error) {
                    console.error(`Error predicting match ${match.fixture.id}:`, error);
                    // Fallback to simple prediction if detailed stats fail
                    allPredictions[match.fixture.id] = {
                        firstHalf: Math.floor(Math.random() * 30 + 40),
                        secondHalf: Math.floor(Math.random() * 30 + 50),
                        factors: ['Basic prediction (detailed stats unavailable)']
                    };
                }
            }
        }

        async function getTeamStatistics(leagueId, teamId) {
            const cacheKey = `stats-${leagueId}-${teamId}`;
            
            // Return cached data if available
            if (historicalDataCache[cacheKey]) {
                return historicalDataCache[cacheKey];
            }
            
            // Fetch from API
            const response = await axios.get(
                `https://v3.football.api-sports.io/teams/statistics?season=${SEASON}&team=${teamId}&league=${leagueId}`, 
                { headers: { 'x-apisports-key': API_KEY } }
            );
            
            // Cache the data
            historicalDataCache[cacheKey] = response.data.response;
            return response.data.response;
        }

        async function getHeadToHead(homeTeamId, awayTeamId) {
            const cacheKey = `h2h-${homeTeamId}-${awayTeamId}`;
            
            if (historicalDataCache[cacheKey]) {
                return historicalDataCache[cacheKey];
            }
            
            const response = await axios.get(
                `https://v3.football.api-sports.io/fixtures/headtohead?h2h=${homeTeamId}-${awayTeamId}&last=5`, 
                { headers: { 'x-apisports-key': API_KEY } }
            );
            
            historicalDataCache[cacheKey] = response.data.response;
            return response.data.response;
        }

        function calculateMatchProbabilities(match, homeStats, awayStats, h2hStats) {
            // Base probabilities
            let firstHalfProb = 45;
            let secondHalfProb = 55;
            const factors = [];
            
            // 1. Team form analysis
            if (homeStats && awayStats) {
                const homeForm = homeStats.form.split('').filter(r => r === 'W').length / 5;
                const awayForm = awayStats.form.split('').filter(r => r === 'L').length / 5;
                
                firstHalfProb += homeForm * 10 - awayForm * 5;
                secondHalfProb += homeForm * 12 - awayForm * 6;
                factors.push(`Home form: ${(homeForm * 100).toFixed(0)}% wins, Away form: ${(awayForm * 100).toFixed(0)}% losses`);
            }
            
            // 2. Goal scoring/conceding trends
            if (homeStats && awayStats) {
                const homeGoalsFor = homeStats.goals.for.average.total;
                const homeGoalsAgainst = homeStats.goals.against.average.total;
                const awayGoalsFor = awayStats.goals.for.average.total;
                const awayGoalsAgainst = awayStats.goals.against.average.total;
                
                firstHalfProb += (homeGoalsFor * 0.7 + awayGoalsAgainst * 0.7 - homeGoalsAgainst * 0.3 - awayGoalsFor * 0.3);
                secondHalfProb += (homeGoalsFor * 0.8 + awayGoalsAgainst * 0.8 - homeGoalsAgainst * 0.2 - awayGoalsFor * 0.2);
                factors.push(`Home scores ${homeGoalsFor.toFixed(1)}/match, concedes ${homeGoalsAgainst.toFixed(1)} | Away scores ${awayGoalsFor.toFixed(1)}, concedes ${awayGoalsAgainst.toFixed(1)}`);
            }
            
            // 3. Head-to-head history
            if (h2hStats && h2hStats.length > 0) {
                let h2hFirstHalfGoals = 0;
                let h2hSecondHalfGoals = 0;
                
                h2hStats.forEach(fixture => {
                    if (fixture.score.halftime.home !== null) {
                        h2hFirstHalfGoals += fixture.score.halftime.home + fixture.score.halftime.away;
                    }
                    if (fixture.score.fulltime.home !== null && fixture.score.halftime.home !== null) {
                        h2hSecondHalfGoals += (fixture.score.fulltime.home - fixture.score.halftime.home) + 
                                              (fixture.score.fulltime.away - fixture.score.halftime.away);
                    }
                });
                
                const avgFirstHalf = h2hFirstHalfGoals / h2hStats.length;
                const avgSecondHalf = h2hSecondHalfGoals / h2hStats.length;
                
                firstHalfProb += (avgFirstHalf - 1.2) * 10;
                secondHalfProb += (avgSecondHalf - 1.3) * 10;
                factors.push(`H2H: ${avgFirstHalf.toFixed(1)} 1H goals, ${avgSecondHalf.toFixed(1)} 2H goals in last ${h2hStats.length} meetings`);
            }
            
            // 4. Home/Away performance
            if (homeStats && awayStats) {
                const homeHomeStrength = homeStats.goals.for.average.home - homeStats.goals.against.average.home;
                const awayAwayWeakness = awayStats.goals.against.average.away - awayStats.goals.for.average.away;
                
                firstHalfProb += homeHomeStrength * 3 + awayAwayWeakness * 2;
                secondHalfProb += homeHomeStrength * 4 + awayAwayWeakness * 3;
                factors.push(`Home team is ${homeHomeStrength > 0 ? 'strong' : 'weak'} at home, Away team is ${awayAwayWeakness > 0 ? 'weak' : 'strong'} away`);
            }
            
            // Ensure probabilities are within reasonable bounds
            firstHalfProb = Math.max(20, Math.min(80, firstHalfProb));
            secondHalfProb = Math.max(30, Math.min(85, secondHalfProb));
            
            return {
                firstHalf: Math.round(firstHalfProb),
                secondHalf: Math.round(secondHalfProb),
                factors: factors
            };
        }

        function showDetailedPredictions() {
            elements.matchesContainer.classList.add('hidden');
            elements.predictionsContainer.classList.remove('hidden');
            
            let html = '';
            
            // Sort matches by kickoff time
            const sortedMatches = [...allMatches].sort((a, b) => 
                new Date(a.fixture.date) - new Date(b.fixture.date)
            );
            
            sortedMatches.forEach(match => {
                if (match.fixture.status.short !== 'NS') return; // Only upcoming matches
                
                const prediction = allPredictions[match.fixture.id] || {
                    firstHalf: 50,
                    secondHalf: 55,
                    factors: ['Prediction data not available']
                };
                
                const homeTeam = match.teams.home.name;
                const awayTeam = match.teams.away.name;
                const matchTime = new Date(match.fixture.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const league = match.league.name;
                
                // Team logos
                const homeLogo = `https://media.api-sports.io/football/teams/${match.teams.home.id}.png`;
                const awayLogo = `https://media.api-sports.io/football/teams/${match.teams.away.id}.png`;
                
                html += `
                    <div class="bg-white rounded-lg shadow overflow-hidden dark:bg-gray-800 p-4 stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg">${homeTeam} vs ${awayTeam}</h3>
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded dark:bg-blue-900 dark:text-blue-100">${league}</span>
                        </div>
                        
                        <div class="flex items-center justify-around mb-4">
                            <div class="text-center">
                                <img src="${homeLogo}" alt="${homeTeam}" class="h-12 mx-auto mb-1" onerror="this.style.display='none'">
                                <span class="font-medium">${homeTeam}</span>
                            </div>
                            <div class="text-center mx-4">
                                <div class="text-2xl font-bold">${matchTime}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Kickoff</div>
                            </div>
                            <div class="text-center">
                                <img src="${awayLogo}" alt="${awayTeam}" class="h-12 mx-auto mb-1" onerror="this.style.display='none'">
                                <span class="font-medium">${awayTeam}</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center p-2 rounded-lg ${getProbabilityClass(prediction.firstHalf)}">
                                <div class="text-3xl font-bold">${prediction.firstHalf}%</div>
                                <div class="text-sm">1st Half Goal</div>
                            </div>
                            <div class="text-center p-2 rounded-lg ${getProbabilityClass(prediction.secondHalf)}">
                                <div class="text-3xl font-bold">${prediction.secondHalf}%</div>
                                <div class="text-sm">2nd Half Goal</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h4 class="font-bold mb-1">Key Factors:</h4>
                            <ul class="list-disc pl-5 text-sm space-y-1">
                                ${prediction.factors.map(factor => `<li>${factor}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>Updated: ${new Date().toLocaleTimeString()}</span>
                            <button onclick="showMatchChart(${match.fixture.id})" class="text-blue-500 hover:underline">
                                View Trends
                            </button>
                        </div>
                    </div>
                `;
            });
            
            elements.predictionsContent.innerHTML = html || `
                <div class="col-span-2 text-center py-8 text-gray-500">
                    No upcoming matches with detailed predictions available.
                </div>
            `;
        }

        // ======================== HELPER FUNCTIONS ========================

        function switchTab(tab) {
            currentTab = tab;
            updateActiveTab();
            
            if (tab === 'predictions') {
                showDetailedPredictions();
            } else {
                elements.matchesContainer.classList.remove('hidden');
                elements.predictionsContainer.classList.add('hidden');
                fetchData();
            }
        }

        function updateActiveTab() {
            elements.inplayTab.className = 
                `px-4 py-2 font-medium ${currentTab === 'inplay' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}`;
            elements.upcomingTab.className = 
                `px-4 py-2 font-medium ${currentTab === 'upcoming' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}`;
            elements.predictionsTab.className = 
                `px-4 py-2 font-medium ${currentTab === 'predictions' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}`;
        }

        function filterMatches() {
            const selectedLeague = elements.leagueFilter.value;
            const minProbability = parseInt(elements.probabilityFilter.value) || 0;
            
            let filteredMatches = allMatches;
            
            // Filter by league
            if (selectedLeague !== 'all') {
                filteredMatches = filteredMatches.filter(match => match.league.name === selectedLeague);
            }
            
            // For in-play matches, show all (we don't have predictions)
            if (currentTab === 'inplay') {
                displayMatches(filteredMatches);
                return;
            }
            
            // For upcoming matches, filter by probability
            filteredMatches = filteredMatches.map(match => {
                // Use our detailed prediction if available
                if (allPredictions[match.fixture.id]) {
                    match.probabilities = {
                        firstHalf: allPredictions[match.fixture.id].firstHalf,
                        secondHalf: allPredictions[match.fixture.id].secondHalf
                    };
                } else {
                    // Fallback to simple prediction
                    match.probabilities = {
                        firstHalf: Math.floor(Math.random() * 30 + 40),
                        secondHalf: Math.floor(Math.random() * 30 + 50)
                    };
                }
                return match;
            }).filter(match => 
                match.probabilities.firstHalf >= minProbability || 
                match.probabilities.secondHalf >= minProbability
            );
            
            displayMatches(filteredMatches);
        }

        function displayMatches(matches) {
            if (!matches || matches.length === 0) {
                elements.matchesContainer.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        No matches found matching your criteria.
                    </div>
                `;
                return;
            }

            // Create header row
            let html = `
                <div class="grid grid-cols-12 bg-blue-600 text-white p-3 font-medium">
                    <div class="col-span-3">Match</div>
                    <div class="col-span-1 text-center">Time</div>
                    <div class="col-span-1 text-center">Score</div>
                    <div class="col-span-2 text-center">1st Half Goal</div>
                    <div class="col-span-2 text-center">2nd Half Goal</div>
                    <div class="col-span-2 text-center">Match Time</div>
                    <div class="col-span-1 text-center">Status</div>
                </div>
            `;

            // Add each match
            matches.forEach(match => {
                const isLive = match.fixture.status.long === 'Match Started';
                const homeTeam = match.teams.home.name;
                const awayTeam = match.teams.away.name;
                const matchTime = new Date(match.fixture.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const status = match.fixture.status.long;
                const elapsed = match.fixture.status.elapsed;
                const homeScore = match.goals.home;
                const awayScore = match.goals.away;
                
                // Get probabilities
                let firstHalfProb, secondHalfProb;
                
                if (isLive) {
                    // For live matches, use simpler calculation
                    firstHalfProb = Math.floor(Math.random() * 30 + 40);
                    secondHalfProb = Math.floor(Math.random() * 30 + 50);
                } else {
                    // For upcoming matches, use our detailed prediction
                    const prediction = allPredictions[match.fixture.id] || {
                        firstHalf: Math.floor(Math.random() * 30 + 40),
                        secondHalf: Math.floor(Math.random() * 30 + 50)
                    };
                    firstHalfProb = prediction.firstHalf;
                    secondHalfProb = prediction.secondHalf;
                }
                
                // Determine probability classes
                const firstHalfClass = getProbabilityClass(firstHalfProb);
                const secondHalfClass = getProbabilityClass(secondHalfProb);
                
                // Match time display
                let matchTimeDisplay = '-';
                if (isLive && elapsed) {
                    matchTimeDisplay = `${elapsed}'`;
                } else if (match.fixture.status.short === 'HT') {
                    matchTimeDisplay = 'HT';
                } else if (match.fixture.status.short === 'FT') {
                    matchTimeDisplay = 'FT';
                }
                
                // Score display
                let scoreDisplay = '-';
                if (homeScore !== null && awayScore !== null) {
                    scoreDisplay = `${homeScore} - ${awayScore}`;
                }
                
                // Team logos
                const homeLogo = `https://media.api-sports.io/football/teams/${match.teams.home.id}.png`;
                const awayLogo = `https://media.api-sports.io/football/teams/${match.teams.away.id}.png`;
                
                html += `
                    <div class="grid grid-cols-12 p-3 border-b match-row ${isLive ? 'bg-blue-50 dark:bg-blue-900/20' : ''}">
                        <div class="col-span-3 flex items-center">
                            <img src="${homeLogo}" alt="${homeTeam}" class="h-6 mr-2" onerror="this.style.display='none'">
                            <span class="font-medium">${homeTeam}</span>
                            <span class="mx-2">vs</span>
                            <img src="${awayLogo}" alt="${awayTeam}" class="h-6 mr-2" onerror="this.style.display='none'">
                            <span class="font-medium">${awayTeam}</span>
                        </div>
                        <div class="col-span-1 text-center self-center">${matchTime}</div>
                        <div class="col-span-1 text-center self-center font-bold ${isLive ? 'text-blue-600 dark:text-blue-400' : ''}">${scoreDisplay}</div>
                        <div class="col-span-2 text-center self-center ${firstHalfClass}">${firstHalfProb}%</div>
                        <div class="col-span-2 text-center self-center ${secondHalfClass}">${secondHalfProb}%</div>
                        <div class="col-span-2 text-center self-center font-medium ${isLive ? 'text-blue-600 dark:text-blue-400' : ''}">${matchTimeDisplay}</div>
                        <div class="col-span-1 text-center self-center">
                            <span class="px-2 py-1 rounded text-xs ${
                                isLive ? 'bg-green-100 text-green-800 live-pulse dark:bg-green-900 dark:text-green-100' : 
                                status === 'Not Started' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100' : 
                                'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                            }">${status}</span>
                        </div>
                    </div>
                `;
            });

            elements.matchesContainer.innerHTML = html;
        }

        function updateLeagueFilter() {
            const leagues = [...new Set(allMatches.map(match => match.league.name))].sort();
            elements.leagueFilter.innerHTML = '<option value="all">All Leagues</option>' + 
                leagues.map(league => `<option value="${league}">${league}</option>`).join('');
        }

        function getProbabilityClass(probability) {
            if (probability >= 70) return 'probability-high';
            if (probability >= 50) return 'probability-medium';
            return 'probability-low';
        }

        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.remove('hidden');
        }

        function startAutoRefresh() {
            clearInterval(autoRefreshInterval);
            if (currentTab === 'inplay') {
                autoRefreshInterval = setInterval(fetchData, 30000); // 30 seconds
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            elements.darkModeToggle.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            localStorage.setItem('darkMode', isDark);
        }

        // Chart function for detailed predictions
        window.showMatchChart = function(fixtureId) {
            const match = allMatches.find(m => m.fixture.id === fixtureId);
            if (!match) return;
            
            const prediction = allPredictions[fixtureId] || {
                firstHalf: 50,
                secondHalf: 55
            };
            
            // Create a modal for the chart
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl dark:bg-gray-800 p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">${match.teams.home.name} vs ${match.teams.away.name}</h3>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            &times;
                        </button>
                    </div>
                    <div class="mb-4">
                        <canvas id="chartCanvas" height="200"></canvas>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-300">
                        <p class="mb-2">Probability analysis based on team statistics, form, and historical data.</p>
                        <p>Match date: ${new Date(match.fixture.date).toLocaleString()}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Create the chart
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1st Half Goal', '2nd Half Goal'],
                    datasets: [{
                        label: 'Probability %',
                        data: [prediction.firstHalf, prediction.secondHalf],
                        backgroundColor: [
                            prediction.firstHalf >= 70 ? 'rgba(40, 167, 69, 0.7)' : 
                            prediction.firstHalf >= 50 ? 'rgba(255, 193, 7, 0.7)' : 'rgba(220, 53, 69, 0.7)',
                            prediction.secondHalf >= 70 ? 'rgba(40, 167, 69, 0.7)' : 
                            prediction.secondHalf >= 50 ? 'rgba(255, 193, 7, 0.7)' : 'rgba(220, 53, 69, 0.7)'
                        ],
                        borderColor: [
                            prediction.firstHalf >= 70 ? 'rgba(40, 167, 69, 1)' : 
                            prediction.firstHalf >= 50 ? 'rgba(255, 193, 7, 1)' : 'rgba(220, 53, 69, 1)',
                            prediction.secondHalf >= 70 ? 'rgba(40, 167, 69, 1)' : 
                            prediction.secondHalf >= 50 ? 'rgba(255, 193, 7, 1)' : 'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + '% probability';
                                }
                            }
                        }
                    }
                }
            });
        };
    </script>
</body>
</html>